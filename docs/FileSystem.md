# 文件系统

## 创建FAT32的磁盘镜像

### 创建空FAT32磁盘镜像
```bash
# 创建磁盘镜像
dd if=/dev/zero of=fs.img bs=512 count=512
# 格式化为FAT32文件系统
mkfs.vfat -F 32 -s 4 fs.img
```
- mkfs 是“make filesystem”的缩写，而 vfat 是指 FAT32 文件系统的一种变种，支持长文件名。
- -F 32：这个选项指定文件系统的类型为 FAT32。
- -s 4：这个选项指定每个分配单元的扇区数。扇区是磁盘存储的基本单元，大多数情况下，一个扇区的大小是 512 字节。这里 -s 4 表示每个簇（FAT文件系统中的分配单元）包含4个扇区，因此每个簇的大小为 2048 字节（4 * 512）。

### 写入编译好的文件
```bash
mount fs.img \\mnt
cp app \\mnt
umount \\mnt
```

### FAT32文件系统的结构

主要可以分为三个部分：
- 启动扇区（Boot Sector）：存储文件系统的基本信息，包括文件系统的类型、磁盘的总容量、每个簇的扇区数。
- 文件分配表（File Allocation Table）：存储对簇的描述信息的表，信息可能为以下几种之一：
    1. 链中下一个簇的地址
    1. 一个特殊的簇链结束符（EOC，End Of Cluster-chain，或称End Of Chain）符号指示链的结束
    1. 一个特殊的符号标示坏簇
    1. 一个特殊的符号标示保留簇
    1. 0来表示空闲簇
- 数据区（Data Area）：存储文件的实际数据。其中包含了根目录区域。
详细结构可见Wiki：[FAT32](https://zh.wikipedia.org/wiki/%E6%AA%94%E6%A1%88%E9%85%8D%E7%BD%AE%E8%A1%A8)
另外再推荐两篇博客：
  - https://www.cnblogs.com/Chary/p/12981056.html
  - https://www.cnblogs.com/caishunzhe/p/12833008.html


#### 根目录区域

此处对根目录区域进行一定的说明。在fat12与fat16中它是紧接在fat区域后面的，而在fat32中并非如此。启动扇区中有根目录起始簇号的信息，而可以根据下面的公式计算出某个簇对应的起始扇区：
$$ 簇号起始扇区 = （簇号-2）* 每个簇的扇区数 + 隐藏扇区数 + 保留扇区数 + FAT数*每个FAT占扇区数 $$
公式中的量均可在启动扇区中找到其对应值。
根目录区域储存根目录下的目录项。

#### 目录项

fat32有两种目录项，一种是短目录项，一种是长目录项。短目录项是8.3命名规则，而长目录项是为了支持长文件名而设计的。
而且fat32中每个文件或目录都会同时有短目录项和长目录项，长目录项位于短目录项之前。

1. 短目录项
    - 每个文件或目录对应一个，占32字节。
    - 储存文件的基本信息，如文件名（过长则截取为短文件名）、文件属性、文件大小、文件的起始簇号等。
2. 长目录项
    - 每一个项占32字节，基本只保存文件名的信息。
    - 一个文件文件名过长时可能对应多个长目录项（至少会有一个），它们逆序排在该文件的短目录项前。
    - 第一个字节存储顺序号或标志该项空闲或标志该文件已被删除。

